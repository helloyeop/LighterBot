# Lighter DEX 자동 거래 시스템 요구사항 명세서

## 1. 프로젝트 개요

### 1.1 목적
TradingView의 기술적 분석 신호를 받아 Lighter DEX에서 자동으로 선물 거래를 실행하는 시스템 구축

### 1.2 범위
- TradingView webhook 신호 수신
- Lighter DEX API를 통한 자동 거래 실행
- 리스크 관리 및 모니터링

### 1.3 기술 스택
- **Language**: Python 3.10+
- **Framework**: FastAPI (webhook server)
- **DEX SDK**: lighter-python
- **Database**: PostgreSQL (거래 기록)
- **Cache**: Redis (상태 관리)
- **Deployment**: Docker

## 2. 기능적 요구사항

### 2.1 Webhook 수신 모듈

#### FR-001: Webhook 엔드포인트
- POST `/webhook/tradingview` 엔드포인트 제공
- JSON 페이로드 수신 및 파싱
- 응답 시간 < 500ms

#### FR-002: 신호 검증
- Secret token 검증 (헤더 또는 페이로드)
- TradingView IP 화이트리스트 검증
- 메시지 포맷 유효성 검사

#### FR-003: 신호 포맷
```json
{
  "secret": "your_secret_token",
  "action": "buy" | "sell" | "close",
  "symbol": "BTC-USD",
  "orderType": "market",
  "quantity": 0.1,
  "leverage": 10,
  "stopLoss": 50000,
  "takeProfit": 60000,
  "alert_time": "2025-01-01T00:00:00Z",
  "strategy": "strategy_name",
  "comment": "optional_comment"
}
```

### 2.2 거래 실행 모듈

#### FR-004: Lighter DEX 연동
- API 키 기반 인증
- 비동기 API 클라이언트 사용
- 자동 재연결 메커니즘

#### FR-005: 주문 실행
- 시장가 주문 실행
- 레버리지 설정 지원 (1x-20x)
- 포지션 크기 자동 계산

#### FR-006: 주문 관리
- 주문 상태 추적 (pending → filled → closed)
- 부분 체결 처리
- 주문 취소 기능

#### FR-007: 포지션 관리
- 현재 포지션 조회
- 포지션 업데이트
- 자동 청산 모니터링

### 2.3 리스크 관리 모듈

#### FR-008: 포지션 크기 제한
- 최대 포지션 크기 설정 (계정 잔고의 X%)
- 심볼별 최대 포지션 제한
- 총 노출도 제한

#### FR-009: 손실 제한
- 일일 최대 손실 제한 (예: -5%)
- 주간 최대 손실 제한 (예: -10%)
- 연속 손실 횟수 제한

#### FR-010: 거래 빈도 제한
- 분당 최대 거래 횟수 제한
- 동일 심볼 연속 거래 간격 설정
- 일일 최대 거래 횟수

#### FR-011: 긴급 정지
- Kill switch 활성화/비활성화
- 모든 포지션 즉시 청산
- 신규 거래 차단

### 2.4 모니터링 모듈

#### FR-012: 거래 로깅
- 모든 거래 활동 데이터베이스 저장
- 실행 시간, 가격, 수량, 수수료 기록
- 성공/실패 상태 추적

#### FR-013: 실시간 알림
- Telegram/Discord 봇 통합
- 주문 실행 알림
- 에러 및 경고 알림
- 일일 요약 리포트

#### FR-014: 대시보드
- 웹 기반 모니터링 인터페이스
- 실시간 P&L 표시
- 거래 히스토리 조회
- 성과 지표 시각화

### 2.5 설정 관리

#### FR-015: 설정 파일
```yaml
lighter:
  api_key: "encrypted_key"
  api_secret: "encrypted_secret"
  network: "mainnet"  # or "testnet"
  
tradingview:
  secret_token: "webhook_secret"
  allowed_ips: ["52.89.214.238", "34.212.75.30"]

risk_management:
  max_position_size_pct: 10
  daily_loss_limit_pct: 5
  max_trades_per_minute: 3
  
notifications:
  telegram:
    enabled: true
    bot_token: "telegram_bot_token"
    chat_id: "chat_id"
```

## 3. 비기능적 요구사항

### 3.1 성능 요구사항

#### NFR-001: 응답 시간
- Webhook 수신 → 주문 전송: < 1초
- 데이터베이스 쿼리: < 100ms

#### NFR-002: 처리량
- 동시 webhook 처리: 최소 10 TPS
- 초당 주문 처리: 최소 5개

#### NFR-003: 가용성
- 시스템 가동률: 99.9% (월간)
- 자동 복구 시간: < 1분

### 3.2 보안 요구사항

#### NFR-004: 인증 및 권한
- API 키 암호화 저장 (AES-256)
- 환경 변수 사용
- 최소 권한 원칙

#### NFR-005: 통신 보안
- HTTPS only
- TLS 1.2 이상
- Rate limiting 구현

#### NFR-006: 감사
- 모든 API 호출 로깅
- 접근 로그 90일 보관
- 이상 활동 탐지

### 3.3 안정성 요구사항

#### NFR-007: 에러 처리
- 모든 예외 상황 처리
- Retry 메커니즘 (exponential backoff)
- Circuit breaker 패턴

#### NFR-008: 데이터 일관성
- 트랜잭션 보장
- 주문 중복 방지
- 상태 동기화

### 3.4 유지보수성

#### NFR-009: 코드 품질
- 테스트 커버리지 > 80%
- Type hints 사용
- 문서화 (docstring)

#### NFR-010: 모니터링
- 로그 레벨 설정 (DEBUG/INFO/ERROR)
- 메트릭 수집 (Prometheus)
- 상태 체크 엔드포인트

## 4. 데이터 요구사항

### 4.1 데이터베이스 스키마

#### 거래 테이블 (trades)
```sql
- id: UUID PRIMARY KEY
- timestamp: TIMESTAMP
- symbol: VARCHAR(20)
- side: ENUM('buy', 'sell')
- quantity: DECIMAL(20, 8)
- price: DECIMAL(20, 8)
- status: ENUM('pending', 'filled', 'cancelled')
- order_id: VARCHAR(100)
- strategy: VARCHAR(50)
- pnl: DECIMAL(20, 8)
```

#### 포지션 테이블 (positions)
```sql
- id: UUID PRIMARY KEY
- symbol: VARCHAR(20)
- side: ENUM('long', 'short')
- quantity: DECIMAL(20, 8)
- entry_price: DECIMAL(20, 8)
- current_price: DECIMAL(20, 8)
- unrealized_pnl: DECIMAL(20, 8)
- leverage: INTEGER
- status: ENUM('open', 'closed')
```

### 4.2 캐시 구조 (Redis)
```
positions:{symbol} - 현재 포지션
daily_trades_count - 일일 거래 횟수
daily_loss - 일일 손실
last_trade_time:{symbol} - 마지막 거래 시간
kill_switch - 긴급 정지 상태
```

## 5. 인터페이스 요구사항

### 5.1 REST API

#### 상태 조회
- `GET /api/health` - 시스템 상태
- `GET /api/positions` - 현재 포지션
- `GET /api/trades` - 거래 내역
- `GET /api/pnl` - 손익 현황

#### 제어 API
- `POST /api/kill-switch` - 긴급 정지
- `POST /api/close-all` - 모든 포지션 청산
- `PUT /api/config` - 설정 업데이트

### 5.2 WebSocket
- 실시간 포지션 업데이트
- 거래 실행 알림
- 시장 데이터 스트리밍

## 6. 개발 단계

### Phase 1: 기본 구조 (Week 1)
- [ ] 프로젝트 구조 설정
- [ ] Lighter SDK 통합
- [ ] 기본 webhook 서버
- [ ] 데이터베이스 설정

### Phase 2: 핵심 기능 (Week 2-3)
- [ ] TradingView webhook 처리
- [ ] 시장가 주문 실행
- [ ] 포지션 관리
- [ ] 기본 리스크 관리

### Phase 3: 고급 기능 (Week 4)
- [ ] 알림 시스템
- [ ] 모니터링 대시보드
- [ ] 성과 분석
- [ ] 백테스팅 도구

### Phase 4: 테스트 및 배포 (Week 5)
- [ ] 단위 테스트
- [ ] 통합 테스트
- [ ] Testnet 검증
- [ ] Production 배포

## 7. 테스트 요구사항

### 7.1 테스트 시나리오
1. Webhook 수신 및 검증
2. 정상 주문 실행
3. 에러 상황 처리
4. 리스크 제한 동작
5. 동시성 테스트
6. 네트워크 장애 복구

### 7.2 성능 테스트
- Load testing (100 req/s)
- Stress testing
- Latency 측정

## 8. 배포 요구사항

### 8.1 환경 구성
- Development (로컬)
- Staging (Testnet)
- Production (Mainnet)

### 8.2 CI/CD
- GitHub Actions
- Docker 컨테이너화
- 자동 테스트 실행
- Blue-Green 배포

## 9. 문서화 요구사항

- API 문서 (OpenAPI/Swagger)
- 설치 가이드
- 운영 매뉴얼
- 트러블슈팅 가이드

## 10. 제약사항 및 가정

### 제약사항
- Lighter DEX API rate limits
- TradingView webhook 제한
- 네트워크 지연

### 가정
- 안정적인 인터넷 연결
- Lighter DEX 서비스 가용성
- TradingView Pro 이상 구독